<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>한빔한복 전지점 랜딩유입 리포트</title>

  <!-- ✅ Paperlogy (Noonnu CDN) -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2307@1.0/Paperlogy.css">

  <!-- ✅ Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --wine:#7A1E2C;
      --bg:#ffffff;
      --text:#1b1b1b;
      --muted:#8c8c8c;
      --radius:16px;
      --pad:16px;
      --border:2px solid var(--wine);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:"Paperlogy",-apple-system,BlinkMacSystemFont,"Noto Sans KR",sans-serif;
    }
    .wrap{
      max-width:520px;
      margin:0 auto;
      padding:0 16px 28px;
    }

    /* ===== Title ===== */
    .title{
      background:var(--wine);
      color:#fff;
      padding:18px 16px;
      font-size:18px;
      font-weight:700;
      letter-spacing:-0.4px;
      border-bottom-left-radius:20px;
      border-bottom-right-radius:20px;
      margin:0 -16px 16px;
    }

    .card{
      background:#fff;
      border:var(--border);
      border-radius:var(--radius);
      padding:var(--pad);
    }

    /* ===== Dropdown ===== */
    select{
      width:100%;
      appearance:none;
      background:#fff;
      color:var(--text);
      border:var(--border);
      border-radius:14px;
      padding:14px;
      font-size:15px;
      font-weight:600;
      outline:none;
    }

    /* ===== Period UI ===== */
    .sectionTitle{
      margin-top:12px;
      font-size:13px;
      font-weight:800;
      letter-spacing:-0.2px;
      color:var(--wine);
    }

    .periodRow{
      display:flex;
      gap:10px;
      margin-top:10px;
    }
    .periodRow input[type="date"]{
      flex:1;
      width:100%;
      border:var(--border);
      border-radius:14px;
      padding:12px 12px;
      font-size:14px;
      font-weight:700;
      outline:none;
      background:#fff;
      color:var(--text);
      min-width:0;
    }

    .presetRow{
      display:flex;
      gap:8px;
      margin-top:10px;
    }
    .presetRow button{
      flex:1;
      border:var(--border);
      background:#fff;
      color:var(--wine);
      border-radius:14px;
      padding:10px 0;
      font-weight:800;
      font-size:14px;
      cursor:pointer;
    }
    .presetRow button.active{
      background:var(--wine);
      color:#fff;
    }

    .applyBtn{
      width:100%;
      margin-top:10px;
      border:var(--border);
      background:var(--wine);
      color:#fff;
      border-radius:14px;
      padding:12px 0;
      font-weight:900;
      font-size:14px;
      cursor:pointer;
    }

    /* ===== Chart Card ===== */
    .chartCard{
      margin-top:14px;
    }
    .meta{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:10px;
      margin-bottom:10px;
    }
    .meta .left{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    .meta .big{
      font-size:16px;
      font-weight:900;
      letter-spacing:-0.4px;
      color:var(--wine);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .meta .small{
      font-size:12px;
      color:var(--muted);
    }

    /* ✅ 무한 높이 이슈 방지: 차트 영역 높이를 고정 */
    .chartWrap{
      height:220px;         /* 여기서 차트 높이 제어 */
      position:relative;
    }
    canvas#lineChart{
      width:100% !important;
      height:100% !important;
      display:block;
    }

    .hint{
      color:var(--muted);
      font-size:12px;
      margin-top:10px;
      line-height:1.45;
    }
    .error{
      color:#c0392b;
      font-size:13px;
      margin-top:10px;
      white-space:pre-wrap;
      display:none;
    }

    /* ===== 2x2 Square Cards ===== */
    .grid{
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:12px;
      margin-top:14px;
    }
    .sq{
      aspect-ratio:1/1;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
    }
    .lbl{
      font-size:13px;
      font-weight:800;
      color:var(--muted);
      letter-spacing:-0.2px;
    }
    .val{
      font-size:30px;
      font-weight:900;
      letter-spacing:-0.8px;
      color:var(--wine);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="title">한빔한복 전지점 랜딩유입 리포트</div>

    <div class="card">
      <!-- 2) Branch dropdown -->
      <select id="branchSelect" aria-label="지점 선택">
        <option value="전체">전체</option>
      </select>

      <!-- 3) 기간 선택 + 프리셋 -->
      <div class="sectionTitle">기간 선택</div>

      <div class="periodRow">
        <input id="fromDate" type="date" aria-label="시작일">
        <input id="toDate" type="date" aria-label="종료일">
      </div>

      <div class="presetRow" role="tablist" aria-label="빠른 기간 선택">
        <button type="button" data-preset="7d" class="active">1주일</button>
        <button type="button" data-preset="1m">1개월</button>
        <button type="button" data-preset="3m">3개월</button>
      </div>

      <button class="applyBtn" id="applyBtn" type="button">기간 적용</button>

      <!-- Chart -->
      <div class="card chartCard">
        <div class="meta">
          <div class="left">
            <div class="big" id="metaTitle">전체</div>
            <div class="small" id="metaRange">-</div>
          </div>
          <div class="big" id="metaTotal">0</div>
        </div>

        <div class="chartWrap">
          <canvas id="lineChart"></canvas>
        </div>

        <div class="error" id="errBox"></div>
      </div>

      <!-- 4) Square cards (2x2) -->
      <div class="grid">
        <div class="card sq">
          <div class="lbl">네이버예약</div>
          <div class="val" id="cardReserve">0</div>
        </div>
        <div class="card sq">
          <div class="lbl">전화문의</div>
          <div class="val" id="cardCall">0</div>
        </div>
        <div class="card sq">
          <div class="lbl">카톡문의</div>
          <div class="val" id="cardKakao">0</div>
        </div>
        <div class="card sq">
          <div class="lbl">더 알아보기</div>
          <div class="val" id="cardMore">0</div>
        </div>
      </div>
    </div>
  </div>

<script>
  /** ✅ 네 GAS WebApp URL로 바꿔 */
  const GAS_URL = "https://script.google.com/macros/s/AKfycbyiPaERPD1ZUBNO7T40wR5Tcy0jU0qtw5SRwBylCHAvRSjafqHOLGkAWGhxKyUgCerM/exec";

  /** 지점 목록(필요하면 실제 표기와 동일하게 맞춰) */
  const BRANCHES = [
    "부산점","센텀점","울산점","김해점","양산점","창원점","마산점","진주점","인천점","안산점","대구점","포항점"
  ];

  const $ = (id)=>document.getElementById(id);

  function fmt(n){
    try{ return Number(n||0).toLocaleString("ko-KR"); }catch(e){ return String(n||0); }
  }

  function dateISO(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const da = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${da}`;
  }

  function setPresetActive(preset){
    document.querySelectorAll(".presetRow button").forEach(b=>{
      b.classList.toggle("active", b.dataset.preset === preset);
    });
  }

  // ✅ 기본값: 최근 7일
  function applyPreset(preset){
    const now = new Date();
    const to = new Date(now);

    const from = new Date(now);
    if(preset === "7d"){
      from.setDate(from.getDate() - 6);
    } else if(preset === "1m"){
      from.setMonth(from.getMonth() - 1);
      from.setDate(from.getDate() + 1); // 대충 1개월 범위(오늘 포함) 감각 맞춤
    } else if(preset === "3m"){
      from.setMonth(from.getMonth() - 3);
      from.setDate(from.getDate() + 1);
    }

    $("fromDate").value = dateISO(from);
    $("toDate").value = dateISO(to);

    setPresetActive(preset);
  }

  // 사용자가 직접 날짜 바꾸면 프리셋 active 해제(심플하게)
  function clearPresetActive(){
    document.querySelectorAll(".presetRow button").forEach(b=> b.classList.remove("active"));
  }

  // Chart
  let chart = null;
  function renderChart(labels, values){
    const ctx = $("lineChart").getContext("2d");
    if(chart) chart.destroy();

    chart = new Chart(ctx, {
      type: "line",
      data: {
        labels,
        datasets: [{
          label: "클릭",
          data: values,
          borderColor: "#7A1E2C",
          backgroundColor: "rgba(122,30,44,0.15)",
          tension: 0.35,
          pointRadius: 2,
          pointHoverRadius: 4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false, // ✅ chartWrap이 높이를 고정하니 이건 OK
        plugins: {
          legend: { display:false },
          tooltip: {
            callbacks: { label: (c)=> ` ${fmt(c.raw)}` }
          }
        },
        scales: {
          x: {
            ticks: { color: "#8c8c8c", maxRotation: 0, autoSkip: true },
            grid: { color: "rgba(122,30,44,0.10)" }
          },
          y: {
            ticks: { color: "#7A1E2C" },
            grid: { color: "rgba(122,30,44,0.10)" }
          }
        }
      }
    });
  }

  function showError(msg){
    const box = $("errBox");
    box.style.display = "block";
    box.textContent = msg;
  }
  function hideError(){
    const box = $("errBox");
    box.style.display = "none";
    box.textContent = "";
  }

  function getRangeSafe(){
    const from = $("fromDate").value;
    const to = $("toDate").value;

    // 최소한의 방어: 값이 없으면 최근 7일로
    if(!from || !to){
      applyPreset("7d");
      return { from: $("fromDate").value, to: $("toDate").value };
    }
    return { from, to };
  }

  async function fetchReport({branch="전체", from, to}){
    // ✅ group은 day 고정 (그래프는 기간 범위 내 일자 흐름)
    const url =
      `${GAS_URL}?page=report` +
      `&branch=${encodeURIComponent(branch)}` +
      `&group=day` +
      `&from=${encodeURIComponent(from)}` +
      `&to=${encodeURIComponent(to)}`;

    const res = await fetch(url, { method:"GET" });
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    return await res.json();
  }

  async function refresh(){
    hideError();

    const branch = $("branchSelect").value || "전체";
    const { from, to } = getRangeSafe();

    try{
      const data = await fetchReport({ branch, from, to });

      $("metaTitle").textContent = (data.branch || branch);
      $("metaRange").textContent = (data.range?.from && data.range?.to) ? `${data.range.from} ~ ${data.range.to}` : `${from} ~ ${to}`;
      $("metaTotal").textContent = fmt(data.cards?.total || 0);

      $("cardReserve").textContent = fmt(data.cards?.reserve || 0);
      $("cardCall").textContent    = fmt(data.cards?.call || 0);
      $("cardKakao").textContent   = fmt(data.cards?.kakao || 0);
      $("cardMore").textContent    = fmt(data.cards?.more || 0);

      renderChart(data.labels || [], data.values || []);
    }catch(err){
      showError("리포트 로드 실패\n" + (err?.message || String(err)));
      $("metaTotal").textContent = "0";
      $("cardReserve").textContent = "0";
      $("cardCall").textContent = "0";
      $("cardKakao").textContent = "0";
      $("cardMore").textContent = "0";
      renderChart([], []);
    }
  }

  function init(){
    // dropdown 채우기
    const sel = $("branchSelect");
    BRANCHES.forEach(b=>{
      const opt = document.createElement("option");
      opt.value = b;
      opt.textContent = b;
      sel.appendChild(opt);
    });

    // 기본 7일
    applyPreset("7d");

    // 이벤트
    sel.addEventListener("change", refresh);

    document.querySelectorAll(".presetRow button").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const preset = btn.dataset.preset;
        applyPreset(preset);
        refresh();
      });
    });

    $("fromDate").addEventListener("change", ()=>{ clearPresetActive(); });
    $("toDate").addEventListener("change", ()=>{ clearPresetActive(); });

    $("applyBtn").addEventListener("click", refresh);

    refresh();
  }

  init();
</script>
</body>
</html>
