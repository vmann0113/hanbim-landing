<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>한빔한복 전지점 랜딩유입 리포트</title>

  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2307@1.0/Paperlogy.css">

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    :root{
      --wine:#7A1E2C;
      --bg:#faf8f7;
      --card:#ffffff;
      --text:#161616;
      --muted:#777;
      --muted2:#9a9a9a;
      --radius:18px;
      --radius2:22px;
      --pad:16px;
      --border:1.6px solid rgba(122,30,44,0.55);
      --borderStrong:2px solid var(--wine);
      --shadow:0 10px 26px rgba(20,12,12,0.08);
      --shadow2:0 6px 16px rgba(20,12,12,0.06);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:"Paperlogy",-apple-system,BlinkMacSystemFont,"Noto Sans KR",sans-serif;
      -webkit-font-smoothing:antialiased;
      text-rendering:optimizeLegibility;
    }

    .wrap{ max-width:560px; margin:0 auto; padding:14px 16px 32px; }

    /* Header */
    .title{
      background:linear-gradient(180deg, #7A1E2C 0%, #651925 100%);
      color:#fff;
      padding:14px 16px;
      font-size:16px;
      font-weight:900;
      letter-spacing:-0.3px;
      border-radius:18px;
      box-shadow:var(--shadow2);
      margin:8px 0 14px;
    }

    /* Containers */
    .card{
      background:var(--card);
      border:var(--border);
      border-radius:var(--radius2);
      padding:var(--pad);
      box-shadow:var(--shadow2);
    }
    .card + .card{ margin-top:12px; }

    /* Select + inputs */
    select{
      width:100%;
      appearance:none;
      background:
        linear-gradient(180deg, #fff 0%, #fbfbfb 100%);
      color:var(--text);
      border:var(--borderStrong);
      border-radius:16px;
      padding:14px 42px 14px 14px;
      font-size:15px;
      font-weight:900;
      outline:none;
      box-shadow:inset 0 1px 0 rgba(0,0,0,0.03);
      background-image:
        linear-gradient(180deg, #fff 0%, #fbfbfb 100%),
        linear-gradient(45deg, transparent 50%, var(--wine) 50%),
        linear-gradient(135deg, var(--wine) 50%, transparent 50%);
      background-position:
        0 0,
        calc(100% - 20px) 50%,
        calc(100% - 14px) 50%;
      background-size:
        auto,
        6px 6px,
        6px 6px;
      background-repeat:no-repeat;
    }

    .sectionTitle{
      margin-top:14px;
      font-size:12px;
      font-weight:900;
      letter-spacing:-0.2px;
      color:var(--wine);
      display:flex;
      align-items:center;
      gap:8px;
    }
    .sectionTitle:before{
      content:"";
      width:8px; height:8px;
      border-radius:99px;
      background:var(--wine);
      opacity:0.9;
    }

    .toggleRow, .presetRow, .btnRow{ display:flex; gap:10px; margin-top:12px; }

    .toggleRow button,
    .presetRow button{
      flex:1;
      border:var(--border);
      background:#fff;
      color:var(--wine);
      border-radius:16px;
      padding:11px 0;
      font-weight:900;
      font-size:13px;
      cursor:pointer;
      box-shadow:inset 0 1px 0 rgba(0,0,0,0.02);
      transition:transform .08s ease, box-shadow .12s ease, background .12s ease, filter .12s ease;
    }
    .toggleRow button:active,
    .presetRow button:active{ transform:translateY(1px); }

    .toggleRow button.active,
    .presetRow button.active{
      background:var(--wine);
      color:#fff;
      border:var(--borderStrong);
      box-shadow:0 10px 18px rgba(122,30,44,0.18);
    }

    .periodRow{ display:flex; gap:10px; margin-top:10px; }
    .periodRow input[type="date"]{
      flex:1; width:100%;
      border:var(--borderStrong);
      border-radius:16px;
      padding:12px 12px;
      font-size:13px;
      font-weight:900;
      outline:none;
      background:linear-gradient(180deg, #fff 0%, #fbfbfb 100%);
      color:var(--text);
      min-width:0;
    }

    /* Buttons */
    .applyBtn{
      flex:1;
      border:var(--borderStrong);
      background:var(--wine);
      color:#fff;
      border-radius:16px;
      padding:12px 0;
      font-weight:900;
      font-size:14px;
      cursor:pointer;
      box-shadow:0 12px 20px rgba(122,30,44,0.20);
      transition:transform .08s ease, filter .12s ease;
    }
    .applyBtn:active{ transform:translateY(1px); filter:brightness(0.98); }

    .exportBtn{
      width:124px;
      border:var(--borderStrong);
      background:#fff;
      color:var(--wine);
      border-radius:16px;
      padding:12px 0;
      font-weight:900;
      font-size:13px;
      cursor:pointer;
      flex:0 0 124px;
      box-shadow:inset 0 1px 0 rgba(0,0,0,0.02);
    }

    /* Chart */
    .chartCard{
      margin-top:14px;
      border:var(--borderStrong);
      background:var(--card);
      border-radius:var(--radius2);
      padding:var(--pad);
      box-shadow:var(--shadow);
    }
    .meta{ display:flex; justify-content:space-between; align-items:flex-end; gap:10px; margin-bottom:10px; }
    .meta .left{ display:flex; flex-direction:column; gap:4px; min-width:0; }
    .meta .big{
      font-size:15px;
      font-weight:900;
      letter-spacing:-0.4px;
      color:var(--wine);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", "Noto Sans KR", sans-serif;
    }
    .meta .small{ font-size:12px; color:var(--muted2); }

    .chartWrap{
      height:310px;
      position:relative;
      border-radius:16px;
      overflow:hidden;
      background:linear-gradient(180deg, #fff 0%, #fbfbfb 100%);
      border:1px solid rgba(122,30,44,0.18);
    }
    canvas#lineChart{ width:100% !important; height:100% !important; display:block; }

    .error{
      color:#c0392b;
      font-size:12px;
      margin-top:10px;
      white-space:pre-wrap;
      display:none;
    }

    /* Stats grid */
    .grid{
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:12px;
      margin-top:14px;
    }
    .sq{
      aspect-ratio:1/1;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      border:var(--borderStrong);
      box-shadow:var(--shadow);
    }
    .lbl{
      font-size:12px;
      font-weight:900;
      color:var(--muted2);
      letter-spacing:-0.1px;
    }
    .val{
      font-size:32px;
      font-weight:900;
      letter-spacing:-0.9px;
      color:var(--wine);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", "Noto Sans KR", sans-serif;
    }

    /* Export doc (keep, but refined) */
    .exportDocWrap{
      position:fixed; left:-99999px; top:0; width:860px;
      background:#fff; padding:28px;
      font-family:"Paperlogy",-apple-system,BlinkMacSystemFont,"Noto Sans KR",sans-serif;
      color:#111;
    }
    .docHeader{ display:flex; justify-content:space-between; align-items:flex-start; gap:16px; margin-bottom:14px; }
    .docTitle{ font-size:22px; font-weight:900; letter-spacing:-0.6px; color:var(--wine); line-height:1.2; }
    .docMeta{ font-size:13px; color:#555; line-height:1.55; text-align:right; white-space:pre-line; }
    .docBox{ border:2px solid var(--wine); border-radius:18px; padding:18px; }
    .docChartRow{ display:grid; grid-template-columns: 1.2fr 0.8fr; gap:14px; align-items:stretch; }
    .docChartCard{ border:2px solid var(--wine); border-radius:16px; padding:14px; background:#fff; }
    .docChartWrap{ height:280px; position:relative; }
    #exportChart{ width:100% !important; height:100% !important; display:block; }
    .docCards{ display:grid; grid-template-columns:repeat(2, 1fr); gap:12px; }
    .docMini{
      border:2px solid var(--wine);
      border-radius:16px;
      padding:14px;
      background:#fff;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      min-height:132px;
    }
    .docMini .t{ font-size:13px; color:#666; font-weight:900; }
    .docMini .n{
      font-size:34px;
      color:var(--wine);
      font-weight:900;
      letter-spacing:-0.8px;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", "Noto Sans KR", sans-serif;
    }
    .docFooter{ margin-top:12px; font-size:12px; color:#777; line-height:1.45; }

    @media (min-width: 900px){
      .wrap{ max-width: 980px; }
      .grid{ grid-template-columns:repeat(4,1fr); }
      .sq{ aspect-ratio:auto; min-height:140px; }
      .chartWrap{ height: 380px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="title">한빔한복 전지점 랜딩유입 리포트</div>

    <div class="card">
      <select id="branchSelect" aria-label="지점 선택">
        <option value="전체">전체</option>
      </select>

      <div class="toggleRow" role="tablist" aria-label="리포트 기준">
        <button type="button" data-group="day" class="active">일별</button>
        <button type="button" data-group="month">월별</button>
      </div>

      <div class="sectionTitle">기간 선택</div>
      <div class="periodRow">
        <input id="fromDate" type="date" aria-label="시작일">
        <input id="toDate" type="date" aria-label="종료일">
      </div>

      <div class="presetRow" role="tablist" aria-label="빠른 기간 선택">
        <button type="button" data-preset="7d" class="active">1주일</button>
        <button type="button" data-preset="1m">1개월</button>
        <button type="button" data-preset="3m">3개월</button>
      </div>

      <div class="btnRow">
        <button class="applyBtn" id="applyBtn" type="button">조회</button>
        <button class="exportBtn" id="exportBtn" type="button">이미지 저장</button>
      </div>

      <!-- NOTE: 기존 "card chartCard" 이중 카드 느낌 줄이려고 card 제거 -->
      <div class="chartCard">
        <div class="meta">
          <div class="left">
            <div class="big" id="metaTitle">전체</div>
            <div class="small" id="metaRange">-</div>
          </div>
          <div class="big" id="metaTotal">0</div>
        </div>

        <div class="chartWrap">
          <canvas id="lineChart"></canvas>
        </div>

        <div class="error" id="errBox"></div>
      </div>

      <div class="grid">
        <div class="card sq">
          <div class="lbl">네이버예약</div>
          <div class="val" id="cardReserve">0</div>
        </div>
        <div class="card sq">
          <div class="lbl">전화문의</div>
          <div class="val" id="cardCall">0</div>
        </div>
        <div class="card sq">
          <div class="lbl">카톡문의</div>
          <div class="val" id="cardKakao">0</div>
        </div>
        <div class="card sq">
          <div class="lbl">더 알아보기</div>
          <div class="val" id="cardMore">0</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Export doc -->
  <div class="exportDocWrap" id="exportDoc">
    <div class="docHeader">
      <div>
        <div class="docTitle">한빔한복 랜딩 유입 리포트</div>
        <div style="margin-top:6px; font-size:13px; color:#444; font-weight:800;" id="exportSub">공유용 리포트</div>
      </div>
      <div class="docMeta" id="exportMeta"></div>
    </div>

    <div class="docBox">
      <div class="docChartRow">
        <div class="docChartCard">
          <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:8px;">
            <div style="font-weight:900; color:var(--wine); font-size:14px;" id="exportChartLabel">그래프</div>
            <div style="font-weight:900; color:var(--wine); font-size:16px; font-family: ui-sans-serif, system-ui, -apple-system, 'Segoe UI', 'Noto Sans KR', sans-serif;" id="exportTotal">0</div>
          </div>
          <div class="docChartWrap">
            <canvas id="exportChart"></canvas>
          </div>
        </div>

        <div class="docCards">
          <div class="docMini"><div class="t">네이버예약</div><div class="n" id="exportReserve">0</div></div>
          <div class="docMini"><div class="t">전화문의</div><div class="n" id="exportCall">0</div></div>
          <div class="docMini"><div class="t">카톡문의</div><div class="n" id="exportKakao">0</div></div>
          <div class="docMini"><div class="t">더 알아보기</div><div class="n" id="exportMore">0</div></div>
        </div>
      </div>

      <div class="docFooter" id="exportFoot">• 네이버예약(reserve)은 오버레이 + CTA가 합산됩니다.</div>
    </div>
  </div>

<script>
  const GAS_URL = "https://script.google.com/macros/s/AKfycbyiPaERPD1ZUBNO7T40wR5Tcy0jU0qtw5SRwBylCHAvRSjafqHOLGkAWGhxKyUgCerM/exec";

  const BRANCHES = [
    "부산점","센텀점","울산점","김해점","양산점","창원점","마산점","진주점","인천점","안산점","대구점","포항점"
  ];

  const COLORS = {
    reserve: { border: "#7A1E2C", fill: "rgba(122,30,44,0.25)" },
    call:    { border: "#B04A57", fill: "rgba(176,74,87,0.25)" },
    kakao:   { border: "#D28A5A", fill: "rgba(210,138,90,0.25)" }
  };

  const $ = (id)=>document.getElementById(id);
  const state = { group:"day", lastData:null };

  function fmt(n){ try{return Number(n||0).toLocaleString("ko-KR");}catch(e){return String(n||0);} }

  function dateISO(d){
    const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"), da=String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${da}`;
  }

  function shortBranchName(name){
    let s = String(name||"").trim();
    if(!s) return s;
    if (s.includes("센텀")) return "센텀";
    if (s.endsWith("점")) s = s.slice(0, -1);
    return s;
  }

  function applyPreset(preset){
    const now = new Date();
    const to = new Date(now);
    const from = new Date(now);

    if(preset==="7d"){ from.setDate(from.getDate()-6); }
    else if(preset==="1m"){ from.setMonth(from.getMonth()-1); from.setDate(from.getDate()+1); }
    else if(preset==="3m"){ from.setMonth(from.getMonth()-3); from.setDate(from.getDate()+1); }

    $("fromDate").value = dateISO(from);
    $("toDate").value = dateISO(to);

    document.querySelectorAll(".presetRow button").forEach(b=>{
      b.classList.toggle("active", b.dataset.preset===preset);
    });
  }

  function clearPresetActive(){
    document.querySelectorAll(".presetRow button").forEach(b=>b.classList.remove("active"));
  }

  function setGroup(group){
    state.group = group;
    document.querySelectorAll(".toggleRow button").forEach(b=>{
      b.classList.toggle("active", b.dataset.group===group);
    });
  }

  function getRangeSafe(){
    let from=$("fromDate").value, to=$("toDate").value;
    if(!from||!to){ applyPreset("7d"); from=$("fromDate").value; to=$("toDate").value; }
    return { from, to };
  }

  // JSONP
  function loadJsonp(url){
    return new Promise((resolve,reject)=>{
      const cb="__hb_cb_"+Math.random().toString(16).slice(2);
      const s=document.createElement("script");
      const sep=url.includes("?") ? "&" : "?";
      s.src = url + sep + "callback=" + cb;

      window[cb]=(data)=>{
        try{ resolve(data); }
        finally{ delete window[cb]; s.remove(); }
      };
      s.onerror=()=>{ delete window[cb]; s.remove(); reject(new Error("JSONP_LOAD_FAILED")); };
      document.head.appendChild(s);
    });
  }

  async function fetchReport({branch="전체", from, to, group="day"}){
    const url = `${GAS_URL}?page=report`
      + `&branch=${encodeURIComponent(branch)}`
      + `&group=${encodeURIComponent(group)}`
      + `&from=${encodeURIComponent(from)}`
      + `&to=${encodeURIComponent(to)}`;
    return await loadJsonp(url);
  }

  function showError(msg){ const b=$("errBox"); b.style.display="block"; b.textContent=msg; }
  function hideError(){ const b=$("errBox"); b.style.display="none"; b.textContent=""; }

  function setCards(cards){
    const c=cards||{};
    $("metaTotal").textContent = fmt(c.total||0);
    $("cardReserve").textContent = fmt(c.reserve||0);
    $("cardCall").textContent = fmt(c.call||0);
    $("cardKakao").textContent = fmt(c.kakao||0);
    $("cardMore").textContent = fmt(c.more||0);
  }

  const ValueLabelPlugin = {
    id: "hb_value_labels",
    afterDatasetsDraw(chart, args, pluginOptions){
      const { ctx } = chart;
      const type = chart.config.type;
      if(type !== "bar") return;

      const opts = pluginOptions || {};
      const minH = opts.minBarHeightPx ?? 16;
      const fontSize = opts.fontSize ?? 11;

      ctx.save();
      ctx.font = `900 ${fontSize}px Paperlogy, sans-serif`;
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";

      chart.data.datasets.forEach((ds, di)=>{
        const meta = chart.getDatasetMeta(di);
        if(meta.hidden) return;

        meta.data.forEach((elem, i)=>{
          const v = Number(ds.data?.[i] || 0);
          if(!v) return;

          const props = elem.getProps(["x","y","base"], true);
          const x = props.x;
          const y = props.y;
          const base = props.base;

          const h = Math.abs(base - y);
          if(h < minH) return;

          const cy = (y + base) / 2;
          ctx.fillStyle = "#ffffff";
          ctx.fillText(String(v), x, cy);
        });
      });

      ctx.restore();
    }
  };

  let chart=null;
  function destroyChart(){ if(chart){ chart.destroy(); chart=null; } }

  function baseOptions(){
    return {
      responsive:true,
      maintainAspectRatio:false,
      plugins:{
        legend:{ display:true, labels:{ usePointStyle:true, boxWidth:10, boxHeight:10 } },
        tooltip:{
          callbacks:{
            label:(c)=>{
              const lbl = c.dataset.label ? (c.dataset.label + ": ") : "";
              return " " + lbl + fmt(c.raw);
            }
          }
        },
        hb_value_labels:{ minBarHeightPx: 16, fontSize: 11 }
      },
      scales:{
        x:{
          type:"category",
          position:"bottom",
          ticks:{ color:"#8c8c8c", maxRotation:0, minRotation:0, autoSkip:true },
          grid:{ color:"rgba(122,30,44,0.10)" }
        },
        y:{
          position:"left",
          beginAtZero:true,
          ticks:{ color:"#7A1E2C" },
          grid:{ color:"rgba(122,30,44,0.10)" }
        }
      }
    };
  }

  function renderStackedBar(rawLabels, series){
    const labels = (rawLabels || []).map(shortBranchName);
    const ctx=$("lineChart").getContext("2d");
    destroyChart();

    const opt = baseOptions();
    opt.scales.x.ticks.autoSkip = false;
    opt.scales.x.ticks.maxRotation = 90;
    opt.scales.x.ticks.minRotation = 90;
    opt.scales.x.stacked = true;
    opt.scales.y.stacked = true;

    chart = new Chart(ctx, {
      type:"bar",
      data:{
        labels,
        datasets:[
          { label:"네이버예약", data: series?.reserve || [], borderColor: COLORS.reserve.border, backgroundColor: COLORS.reserve.fill, borderWidth: 1.2, borderRadius: 8, stack: "total" },
          { label:"전화문의",   data: series?.call || [],    borderColor: COLORS.call.border,    backgroundColor: COLORS.call.fill,    borderWidth: 1.2, borderRadius: 8, stack: "total" },
          { label:"카톡문의",   data: series?.kakao || [],   borderColor: COLORS.kakao.border,   backgroundColor: COLORS.kakao.fill,   borderWidth: 1.2, borderRadius: 8, stack: "total" }
        ]
      },
      options: opt,
      plugins: [ValueLabelPlugin]
    });
  }

  function renderMultiLine(labels, series){
    const ctx=$("lineChart").getContext("2d");
    destroyChart();

    const opt = baseOptions();

    chart = new Chart(ctx, {
      type:"line",
      data:{
        labels: labels || [],
        datasets:[
          { label:"네이버예약", data: series?.reserve || [], borderColor: COLORS.reserve.border, backgroundColor: COLORS.reserve.fill, tension: 0.35, pointRadius: (state.group==="month") ? 0 : 2, pointHoverRadius: (state.group==="month") ? 0 : 4 },
          { label:"전화문의",   data: series?.call || [],    borderColor: COLORS.call.border,    backgroundColor: COLORS.call.fill,    tension: 0.35, pointRadius: (state.group==="month") ? 0 : 2, pointHoverRadius: (state.group==="month") ? 0 : 4 },
          { label:"카톡문의",   data: series?.kakao || [],   borderColor: COLORS.kakao.border,   backgroundColor: COLORS.kakao.fill,   tension: 0.35, pointRadius: (state.group==="month") ? 0 : 2, pointHoverRadius: (state.group==="month") ? 0 : 4 }
        ]
      },
      options: opt
    });
  }

  let exportChart=null;
  function destroyExportChart(){ if(exportChart){ exportChart.destroy(); exportChart=null; } }

  function renderExport(labels, series, isAll){
    const ctx=$("exportChart").getContext("2d");
    destroyExportChart();

    const common = {
      responsive:true,
      maintainAspectRatio:false,
      animation:false,
      plugins:{ legend:{ display:true } },
      scales:{
        x:{ type:"category", position:"bottom", grid:{ color:"rgba(122,30,44,0.08)" } },
        y:{ position:"left", beginAtZero:true, grid:{ color:"rgba(122,30,44,0.08)" } }
      }
    };

    if(isAll){
      common.scales.x.ticks = { autoSkip:false, maxRotation:90, minRotation:90 };
      common.scales.x.stacked = true;
      common.scales.y.stacked = true;

      exportChart = new Chart(ctx,{
        type:"bar",
        data:{
          labels: (labels||[]).map(shortBranchName),
          datasets:[
            { label:"네이버예약", data: series?.reserve||[], borderColor:COLORS.reserve.border, backgroundColor:COLORS.reserve.fill, stack:"total", borderWidth:1.2, borderRadius:10 },
            { label:"전화문의",   data: series?.call||[],    borderColor:COLORS.call.border,    backgroundColor:COLORS.call.fill,    stack:"total", borderWidth:1.2, borderRadius:10 },
            { label:"카톡문의",   data: series?.kakao||[],   borderColor:COLORS.kakao.border,   backgroundColor:COLORS.kakao.fill,   stack:"total", borderWidth:1.2, borderRadius:10 }
          ]
        },
        options: common,
        plugins:[ValueLabelPlugin]
      });
    }else{
      common.scales.x.ticks = { autoSkip:true, maxRotation:0, minRotation:0 };

      exportChart = new Chart(ctx,{
        type:"line",
        data:{
          labels: labels||[],
          datasets:[
            { label:"네이버예약", data: series?.reserve||[], borderColor:COLORS.reserve.border, backgroundColor:COLORS.reserve.fill, tension:0.35, pointRadius:0 },
            { label:"전화문의",   data: series?.call||[],    borderColor:COLORS.call.border,    backgroundColor:COLORS.call.fill,    tension:0.35, pointRadius:0 },
            { label:"카톡문의",   data: series?.kakao||[],   borderColor:COLORS.kakao.border,   backgroundColor:COLORS.kakao.fill,   tension:0.35, pointRadius:0 }
          ]
        },
        options: common
      });
    }
  }

  function safeFileName(branch, from, to, group){
    const b=String(branch||"전체").replace(/\s+/g,"");
    const g=(group==="month")?"month":"day";
    return `hanbeam_report_${b}_${g}_${from}_${to}.png`;
  }

  async function exportAsImage(){
    if(!state.lastData){
      await refresh();
      if(!state.lastData){ alert("리포트를 먼저 조회해 주세요."); return; }
    }

    const branch=$("branchSelect").value||"전체";
    const {from,to}=getRangeSafe();
    const group=state.group;
    const gLabel=(group==="month")?"월별":"일별";

    const now=new Date();
    const generatedAt =
      `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')} ` +
      `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;

    const isAll = (state.lastData.mode==="all_compare");

    $("exportSub").textContent = isAll ? `지점별 비교 요약 (${gLabel})` : `지점별 클릭 요약 (${gLabel})`;
    $("exportChartLabel").textContent = isAll ? `지점별 비교 (${gLabel})` : `기간 내 추이 (${gLabel})`;

    $("exportMeta").textContent =
      `지점: ${branch}\n기준: ${gLabel}\n기간: ${from} ~ ${to}\n생성: ${generatedAt}`;

    const cards=state.lastData.cards||{};
    $("exportTotal").textContent=fmt(cards.total||0);
    $("exportReserve").textContent=fmt(cards.reserve||0);
    $("exportCall").textContent=fmt(cards.call||0);
    $("exportKakao").textContent=fmt(cards.kakao||0);
    $("exportMore").textContent=fmt(cards.more||0);

    renderExport(state.lastData.labels||[], state.lastData.series||{}, isAll);
    await new Promise(r=>setTimeout(r,140));

    const canvas = await html2canvas($("exportDoc"), { backgroundColor:"#fff", scale:2, useCORS:true });
    const a=document.createElement("a");
    a.href=canvas.toDataURL("image/png");
    a.download=safeFileName(branch, from, to, group);
    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  async function refresh(){
    hideError();
    const branch=$("branchSelect").value||"전체";
    const {from,to}=getRangeSafe();

    try{
      const data = await fetchReport({ branch, from, to, group: state.group });
      state.lastData=data;

      const gLabel=(state.group==="month")?"월별":"일별";
      $("metaRange").textContent = `${from} ~ ${to}`;

      setCards(data.cards);

      if(data.mode==="all_compare"){
        $("metaTitle").textContent = `전체 · 지점별 비교 · ${gLabel}`;
        renderStackedBar(data.labels||[], data.series||{});
      }else{
        $("metaTitle").textContent = `${shortBranchName(branch)} · ${gLabel}`;
        renderMultiLine(data.labels||[], data.series||{});
      }

    }catch(err){
      state.lastData=null;
      showError("리포트 로드 실패\n" + (err?.message || String(err)));
      setCards({total:0,reserve:0,call:0,kakao:0,more:0});
      destroyChart();
    }
  }

  function init(){
    const sel=$("branchSelect");
    BRANCHES.forEach(b=>{
      const opt=document.createElement("option");
      opt.value=b; opt.textContent=b;
      sel.appendChild(opt);
    });

    applyPreset("7d");
    setGroup("day");

    sel.addEventListener("change", refresh);

    document.querySelectorAll(".toggleRow button").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        setGroup(btn.dataset.group);
        refresh();
      });
    });

    document.querySelectorAll(".presetRow button").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        applyPreset(btn.dataset.preset);
        refresh();
      });
    });

    $("fromDate").addEventListener("change", clearPresetActive);
    $("toDate").addEventListener("change", clearPresetActive);

    $("applyBtn").addEventListener("click", refresh);
    $("exportBtn").addEventListener("click", exportAsImage);

    refresh();
  }

  init();
</script>
</body>
</html>
