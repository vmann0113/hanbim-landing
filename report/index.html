<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>한빔한복 전지점 랜딩유입 리포트</title>

  <!-- ✅ Paperlogy (Noonnu CDN) -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2307@1.0/Paperlogy.css">

  <!-- ✅ Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- ✅ Export to Image -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    :root{
      --wine:#7A1E2C;
      --bg:#ffffff;
      --text:#1b1b1b;
      --muted:#8c8c8c;
      --radius:16px;
      --pad:16px;
      --border:2px solid var(--wine);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:"Paperlogy",-apple-system,BlinkMacSystemFont,"Noto Sans KR",sans-serif;
    }
    .wrap{
      max-width:520px;
      margin:0 auto;
      padding:0 16px 28px;
    }

    /* ===== Title ===== */
    .title{
      background:var(--wine);
      color:#fff;
      padding:18px 16px;
      font-size:18px;
      font-weight:700;
      letter-spacing:-0.4px;
      border-bottom-left-radius:20px;
      border-bottom-right-radius:20px;
      margin:0 -16px 16px;
    }

    .card{
      background:#fff;
      border:var(--border);
      border-radius:var(--radius);
      padding:var(--pad);
    }

    /* ===== Dropdown ===== */
    select{
      width:100%;
      appearance:none;
      background:#fff;
      color:var(--text);
      border:var(--border);
      border-radius:14px;
      padding:14px;
      font-size:15px;
      font-weight:600;
      outline:none;
    }

    /* ===== Toggle ===== */
    .toggleRow{
      display:flex;
      gap:8px;
      margin-top:12px;
    }
    .toggleRow button{
      flex:1;
      border:var(--border);
      background:#fff;
      color:var(--wine);
      border-radius:14px;
      padding:10px 0;
      font-weight:900;
      font-size:14px;
      cursor:pointer;
    }
    .toggleRow button.active{
      background:var(--wine);
      color:#fff;
    }

    /* ===== Period UI ===== */
    .sectionTitle{
      margin-top:12px;
      font-size:13px;
      font-weight:900;
      letter-spacing:-0.2px;
      color:var(--wine);
    }

    .periodRow{
      display:flex;
      gap:10px;
      margin-top:10px;
    }
    .periodRow input[type="date"]{
      flex:1;
      width:100%;
      border:var(--border);
      border-radius:14px;
      padding:12px 12px;
      font-size:14px;
      font-weight:800;
      outline:none;
      background:#fff;
      color:var(--text);
      min-width:0;
    }

    .presetRow{
      display:flex;
      gap:8px;
      margin-top:10px;
    }
    .presetRow button{
      flex:1;
      border:var(--border);
      background:#fff;
      color:var(--wine);
      border-radius:14px;
      padding:10px 0;
      font-weight:900;
      font-size:14px;
      cursor:pointer;
    }
    .presetRow button.active{
      background:var(--wine);
      color:#fff;
    }

    .btnRow{
      display:flex;
      gap:10px;
      margin-top:10px;
    }
    .applyBtn{
      flex:1;
      border:var(--border);
      background:var(--wine);
      color:#fff;
      border-radius:14px;
      padding:12px 0;
      font-weight:900;
      font-size:14px;
      cursor:pointer;
    }
    .exportBtn{
      width:120px;
      border:var(--border);
      background:#fff;
      color:var(--wine);
      border-radius:14px;
      padding:12px 0;
      font-weight:900;
      font-size:14px;
      cursor:pointer;
      flex:0 0 120px;
    }

    /* ===== Chart Card ===== */
    .chartCard{
      margin-top:14px;
    }
    .meta{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:10px;
      margin-bottom:10px;
    }
    .meta .left{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    .meta .big{
      font-size:16px;
      font-weight:900;
      letter-spacing:-0.4px;
      color:var(--wine);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .meta .small{
      font-size:12px;
      color:var(--muted);
    }

    /* ✅ 무한 높이 이슈 방지: 차트 영역 고정 */
    .chartWrap{
      height:220px;
      position:relative;
    }
    canvas#lineChart{
      width:100% !important;
      height:100% !important;
      display:block;
    }

    .hint{
      color:var(--muted);
      font-size:12px;
      margin-top:10px;
      line-height:1.45;
    }
    .error{
      color:#c0392b;
      font-size:13px;
      margin-top:10px;
      white-space:pre-wrap;
      display:none;
    }

    /* ===== 2x2 Square Cards ===== */
    .grid{
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:12px;
      margin-top:14px;
    }
    .sq{
      aspect-ratio:1/1;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
    }
    .lbl{
      font-size:13px;
      font-weight:900;
      color:var(--muted);
      letter-spacing:-0.2px;
    }
    .val{
      font-size:30px;
      font-weight:900;
      letter-spacing:-0.8px;
      color:var(--wine);
    }

    /* ===== Export Doc (hidden) ===== */
    .exportDocWrap{
      position:fixed;
      left:-99999px;
      top:0;
      width:860px; /* 문서 느낌 */
      background:#fff;
      padding:28px;
      font-family:"Paperlogy",-apple-system,BlinkMacSystemFont,"Noto Sans KR",sans-serif;
      color:#111;
    }
    .docHeader{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:16px;
      margin-bottom:14px;
    }
    .docTitle{
      font-size:22px;
      font-weight:900;
      letter-spacing:-0.6px;
      color:var(--wine);
      line-height:1.2;
    }
    .docMeta{
      font-size:13px;
      color:#555;
      line-height:1.55;
      text-align:right;
      white-space:pre-line;
    }
    .docBox{
      border:2px solid var(--wine);
      border-radius:18px;
      padding:18px;
    }
    .docChartRow{
      display:grid;
      grid-template-columns: 1.2fr 0.8fr;
      gap:14px;
      align-items:stretch;
    }
    .docChartCard{
      border:2px solid var(--wine);
      border-radius:16px;
      padding:14px;
      position:relative;
      background:#fff;
    }
    .docChartWrap{
      height:280px;
      position:relative;
    }
    #exportChart{
      width:100% !important;
      height:100% !important;
      display:block;
    }
    .docCards{
      display:grid;
      grid-template-columns:repeat(2, 1fr);
      gap:12px;
    }
    .docMini{
      border:2px solid var(--wine);
      border-radius:16px;
      padding:14px;
      background:#fff;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      min-height:132px;
    }
    .docMini .t{
      font-size:13px;
      color:#666;
      font-weight:900;
    }
    .docMini .n{
      font-size:34px;
      color:var(--wine);
      font-weight:900;
      letter-spacing:-0.8px;
    }
    .docFooter{
      margin-top:12px;
      font-size:12px;
      color:#777;
      line-height:1.45;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="title">한빔한복 전지점 랜딩유입 리포트</div>

    <div class="card">
      <!-- Branch dropdown -->
      <select id="branchSelect" aria-label="지점 선택">
        <option value="전체">전체</option>
      </select>

      <!-- ✅ 일별/월별 토글 -->
      <div class="toggleRow" role="tablist" aria-label="리포트 기준">
        <button type="button" data-group="day" class="active" id="btnDay">일별</button>
        <button type="button" data-group="month" id="btnMonth">월별</button>
      </div>

      <!-- 기간 선택 + 프리셋 -->
      <div class="sectionTitle">기간 선택</div>

      <div class="periodRow">
        <input id="fromDate" type="date" aria-label="시작일">
        <input id="toDate" type="date" aria-label="종료일">
      </div>

      <div class="presetRow" role="tablist" aria-label="빠른 기간 선택">
        <button type="button" data-preset="7d" class="active">1주일</button>
        <button type="button" data-preset="1m">1개월</button>
        <button type="button" data-preset="3m">3개월</button>
      </div>

      <div class="btnRow">
        <button class="applyBtn" id="applyBtn" type="button">조회</button>
        <button class="exportBtn" id="exportBtn" type="button">이미지 저장</button>
      </div>

      <!-- Chart -->
      <div class="card chartCard">
        <div class="meta">
          <div class="left">
            <div class="big" id="metaTitle">전체</div>
            <div class="small" id="metaRange">-</div>
          </div>
          <div class="big" id="metaTotal">0</div>
        </div>

        <div class="chartWrap">
          <canvas id="lineChart"></canvas>
        </div>

        <div class="hint">
          • 네이버예약(reserve)은 <b>오버레이 + CTA</b> 클릭이 합산됩니다.<br>
          • “더 알아보기”는 지점을 선택하지 않은 경우 <b>전체</b>로 집계될 수 있습니다.
        </div>
        <div class="error" id="errBox"></div>
      </div>

      <!-- 2x2 Square cards -->
      <div class="grid">
        <div class="card sq">
          <div class="lbl">네이버예약</div>
          <div class="val" id="cardReserve">0</div>
        </div>
        <div class="card sq">
          <div class="lbl">전화문의</div>
          <div class="val" id="cardCall">0</div>
        </div>
        <div class="card sq">
          <div class="lbl">카톡문의</div>
          <div class="val" id="cardKakao">0</div>
        </div>
        <div class="card sq">
          <div class="lbl">더 알아보기</div>
          <div class="val" id="cardMore">0</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== Hidden Export Doc ===== -->
  <div class="exportDocWrap" id="exportDoc">
    <div class="docHeader">
      <div>
        <div class="docTitle">한빔한복 랜딩 유입 리포트</div>
        <div style="margin-top:6px; font-size:13px; color:#444; font-weight:800;" id="exportSub">
          지점별 클릭 요약 (일별/월별 공유용)
        </div>
      </div>
      <div class="docMeta" id="exportMeta"></div>
    </div>

    <div class="docBox">
      <div class="docChartRow">
        <div class="docChartCard">
          <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:8px;">
            <div style="font-weight:900; color:var(--wine); font-size:14px;" id="exportChartLabel">기간 내 추이</div>
            <div style="font-weight:900; color:var(--wine); font-size:16px;" id="exportTotal">0</div>
          </div>
          <div class="docChartWrap">
            <canvas id="exportChart"></canvas>
          </div>
        </div>

        <div class="docCards">
          <div class="docMini">
            <div class="t">네이버예약</div>
            <div class="n" id="exportReserve">0</div>
          </div>
          <div class="docMini">
            <div class="t">전화문의</div>
            <div class="n" id="exportCall">0</div>
          </div>
          <div class="docMini">
            <div class="t">카톡문의</div>
            <div class="n" id="exportKakao">0</div>
          </div>
          <div class="docMini">
            <div class="t">더 알아보기</div>
            <div class="n" id="exportMore">0</div>
          </div>
        </div>
      </div>

      <div class="docFooter">
        • 네이버예약(reserve)은 오버레이 + CTA가 합산됩니다.<br>
        • 생성일시/기간/지점/기준(일별/월별)이 포함되어 지점별 월별 보고에 바로 사용 가능합니다.
      </div>
    </div>
  </div>

<script>
  /** ✅ 너 WebApp /exec URL */
  const GAS_URL = "https://script.google.com/macros/s/AKfycbyiPaERPD1ZUBNO7T40wR5Tcy0jU0qtw5SRwBylCHAvRSjafqHOLGkAWGhxKyUgCerM/exec";

  /** 지점 목록(실제 표기와 동일하게) */
  const BRANCHES = [
    "부산점","센텀점","울산점","김해점","양산점","창원점","마산점","진주점","인천점","안산점","대구점","포항점"
  ];

  const $ = (id)=>document.getElementById(id);

  const state = {
    group: "day",   // day|month
    lastData: null
  };

  function fmt(n){
    try{ return Number(n||0).toLocaleString("ko-KR"); }catch(e){ return String(n||0); }
  }

  function dateISO(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const da = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${da}`;
  }

  function setGroupActive(group){
    state.group = group;
    document.querySelectorAll(".toggleRow button").forEach(b=>{
      b.classList.toggle("active", b.dataset.group === group);
    });
  }

  function setPresetActive(preset){
    document.querySelectorAll(".presetRow button").forEach(b=>{
      b.classList.toggle("active", b.dataset.preset === preset);
    });
  }

  // ✅ 기본값: 최근 7일
  function applyPreset(preset){
    const now = new Date();
    const to = new Date(now);

    const from = new Date(now);
    if(preset === "7d"){
      from.setDate(from.getDate() - 6);
    } else if(preset === "1m"){
      from.setMonth(from.getMonth() - 1);
      from.setDate(from.getDate() + 1);
    } else if(preset === "3m"){
      from.setMonth(from.getMonth() - 3);
      from.setDate(from.getDate() + 1);
    }

    $("fromDate").value = dateISO(from);
    $("toDate").value = dateISO(to);

    setPresetActive(preset);
  }

  function clearPresetActive(){
    document.querySelectorAll(".presetRow button").forEach(b=> b.classList.remove("active"));
  }

  /** ===== JSONP Loader (CORS-free) ===== */
  function loadJsonp(url){
    return new Promise((resolve, reject)=>{
      const cbName = "__hb_cb_" + Math.random().toString(16).slice(2);
      const s = document.createElement("script");
      const sep = url.includes("?") ? "&" : "?";
      s.src = url + sep + "callback=" + cbName;

      window[cbName] = (data)=>{
        try{ resolve(data); }
        finally{
          delete window[cbName];
          s.remove();
        }
      };

      s.onerror = ()=>{
        delete window[cbName];
        s.remove();
        reject(new Error("JSONP_LOAD_FAILED"));
      };

      document.head.appendChild(s);
    });
  }

  async function fetchReport({branch="전체", from, to, group="day"}){
    const url =
      `${GAS_URL}?page=report` +
      `&branch=${encodeURIComponent(branch)}` +
      `&group=${encodeURIComponent(group)}` +
      `&from=${encodeURIComponent(from)}` +
      `&to=${encodeURIComponent(to)}`;
    return await loadJsonp(url);
  }

  // Chart (screen)
  let chart = null;
  function renderChart(labels, values){
    const ctx = $("lineChart").getContext("2d");
    if(chart) chart.destroy();

    chart = new Chart(ctx, {
      type: "line",
      data: {
        labels,
        datasets: [{
          label: "클릭",
          data: values,
          borderColor: "#7A1E2C",
          backgroundColor: "rgba(122,30,44,0.15)",
          tension: 0.35,
          pointRadius: (state.group === "month") ? 0 : 2,
          pointHoverRadius: (state.group === "month") ? 0 : 4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display:false },
          tooltip: { callbacks: { label: (c)=> ` ${fmt(c.raw)}` } }
        },
        scales: {
          x: {
            ticks: { color: "#8c8c8c", maxRotation: 0, autoSkip: true },
            grid: { color: "rgba(122,30,44,0.10)" }
          },
          y: {
            ticks: { color: "#7A1E2C" },
            grid: { color: "rgba(122,30,44,0.10)" }
          }
        }
      }
    });
  }

  // Chart (export doc)
  let exportChart = null;
  function renderExportChart(labels, values){
    const ctx = $("exportChart").getContext("2d");
    if(exportChart) exportChart.destroy();

    exportChart = new Chart(ctx, {
      type: "line",
      data: {
        labels,
        datasets: [{
          label: "클릭",
          data: values,
          borderColor: "#7A1E2C",
          backgroundColor: "rgba(122,30,44,0.12)",
          tension: 0.35,
          pointRadius: 0,
          pointHoverRadius: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: false,
        plugins: { legend: { display:false } },
        scales: {
          x: { ticks: { maxRotation: 0, autoSkip: true }, grid: { color:"rgba(122,30,44,0.08)" } },
          y: { ticks: { autoSkip: true }, grid: { color:"rgba(122,30,44,0.08)" } }
        }
      }
    });
  }

  function showError(msg){
    const box = $("errBox");
    box.style.display = "block";
    box.textContent = msg;
  }
  function hideError(){
    const box = $("errBox");
    box.style.display = "none";
    box.textContent = "";
  }

  function getRangeSafe(){
    const from = $("fromDate").value;
    const to = $("toDate").value;
    if(!from || !to){
      applyPreset("7d");
      return { from: $("fromDate").value, to: $("toDate").value };
    }
    return { from, to };
  }

  async function refresh(){
    hideError();

    const branch = $("branchSelect").value || "전체";
    const { from, to } = getRangeSafe();

    try{
      const data = await fetchReport({ branch, from, to, group: state.group });
      state.lastData = data;

      const gLabel = (state.group === "month") ? "월별" : "일별";
      $("metaTitle").textContent = `${data.branch || branch} · ${gLabel}`;
      $("metaRange").textContent = (data.range?.from && data.range?.to)
        ? `${data.range.from} ~ ${data.range.to}`
        : `${from} ~ ${to}`;
      $("metaTotal").textContent = fmt(data.cards?.total || 0);

      $("cardReserve").textContent = fmt(data.cards?.reserve || 0);
      $("cardCall").textContent    = fmt(data.cards?.call || 0);
      $("cardKakao").textContent   = fmt(data.cards?.kakao || 0);
      $("cardMore").textContent    = fmt(data.cards?.more || 0);

      renderChart(data.labels || [], data.values || []);
    }catch(err){
      state.lastData = null;
      showError("리포트 로드 실패\n" + (err?.message || String(err)));
      $("metaTotal").textContent = "0";
      $("cardReserve").textContent = "0";
      $("cardCall").textContent = "0";
      $("cardKakao").textContent = "0";
      $("cardMore").textContent = "0";
      renderChart([], []);
    }
  }

  function safeFileName(branch, from, to, group){
    const b = String(branch || "전체").replace(/\s+/g,"");
    const g = (group === "month") ? "month" : "day";
    return `hanbeam_report_${b}_${g}_${from}_${to}.png`;
  }

  async function exportAsImage(){
    // 데이터가 없으면 먼저 조회
    if(!state.lastData){
      await refresh();
      if(!state.lastData){
        alert("리포트를 먼저 조회해 주세요.");
        return;
      }
    }

    const branch = $("branchSelect").value || "전체";
    const { from, to } = getRangeSafe();
    const group = state.group;

    const now = new Date();
    const generatedAt = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;

    const gLabel = (group === "month") ? "월별" : "일별";
    $("exportSub").textContent = `지점별 클릭 요약 (${gLabel} 공유용)`;
    $("exportChartLabel").textContent = `기간 내 추이 (${gLabel})`;

    $("exportMeta").textContent =
      `지점: ${branch}\n기준: ${gLabel}\n기간: ${from} ~ ${to}\n생성: ${generatedAt}`;

    // 수치 반영
    $("exportTotal").textContent   = fmt(state.lastData.cards?.total || 0);
    $("exportReserve").textContent = fmt(state.lastData.cards?.reserve || 0);
    $("exportCall").textContent    = fmt(state.lastData.cards?.call || 0);
    $("exportKakao").textContent   = fmt(state.lastData.cards?.kakao || 0);
    $("exportMore").textContent    = fmt(state.lastData.cards?.more || 0);

    // export 차트 렌더
    renderExportChart(state.lastData.labels || [], state.lastData.values || []);

    await new Promise(r=>setTimeout(r, 120));

    const node = $("exportDoc");

    const canvas = await html2canvas(node, {
      backgroundColor: "#ffffff",
      scale: 2,
      useCORS: true
    });

    const a = document.createElement("a");
    a.href = canvas.toDataURL("image/png");
    a.download = safeFileName(branch, from, to, group);
    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  function init(){
    // dropdown 채우기
    const sel = $("branchSelect");
    BRANCHES.forEach(b=>{
      const opt = document.createElement("option");
      opt.value = b;
      opt.textContent = b;
      sel.appendChild(opt);
    });

    // 기본 7일
    applyPreset("7d");
    setGroupActive("day");

    // 이벤트
    sel.addEventListener("change", refresh);

    // 토글
    document.querySelectorAll(".toggleRow button").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        setGroupActive(btn.dataset.group);
        refresh();
      });
    });

    document.querySelectorAll(".presetRow button").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        applyPreset(btn.dataset.preset);
        refresh();
      });
    });

    $("fromDate").addEventListener("change", clearPresetActive);
    $("toDate").addEventListener("change", clearPresetActive);

    $("applyBtn").addEventListener("click", refresh);
    $("exportBtn").addEventListener("click", exportAsImage);

    refresh();
  }

  init();
</script>
</body>
</html>
