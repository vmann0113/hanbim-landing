<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>한빔한복 전지점 랜딩유입 리포트</title>

  <!-- ✅ Paperlogy (Noonnu CDN) -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2307@1.0/Paperlogy.css">

  <!-- ✅ Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --wine:#7A1E2C;
      --wine-soft:#8E2A3A;
      --bg:#ffffff;
      --text:#1b1b1b;
      --muted:#8c8c8c;
      --radius:16px;
      --pad:16px;
      --border:2px solid var(--wine);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:"Paperlogy",-apple-system,BlinkMacSystemFont,"Noto Sans KR",sans-serif;
    }
    .wrap{
      max-width: 520px;
      margin: 0 auto;
      padding: 0 16px 28px;
    }

    /* ===== Title ===== */
    .title{
      background: var(--wine);
      color:#fff;
      padding: 18px 16px;
      font-size: 18px;
      font-weight: 700;
      letter-spacing: -0.4px;
      border-bottom-left-radius: 20px;
      border-bottom-right-radius: 20px;
      margin: 0 -16px 16px;
    }

    .card{
      background:#fff;
      border: var(--border);
      border-radius: var(--radius);
      padding: var(--pad);
    }

    /* ===== Dropdown ===== */
    select{
      width:100%;
      appearance:none;
      background:#fff;
      color:var(--text);
      border: var(--border);
      border-radius: 14px;
      padding: 14px;
      font-size: 15px;
      font-weight: 600;
      outline:none;
    }

    /* ===== Segmented (day/month/year) ===== */
    .seg{
      display:flex;
      gap:8px;
      margin-top: 12px;
    }
    .seg button{
      flex:1;
      border: var(--border);
      background:#fff;
      color:var(--wine);
      border-radius: 14px;
      padding: 10px 0;
      font-weight: 700;
      font-size: 14px;
      cursor:pointer;
    }
    .seg button.active{
      background: var(--wine);
      color:#fff;
    }

    /* ===== Chart card ===== */
    .chartCard{
      margin-top: 14px;
    }
    .meta{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap: 10px;
      margin-bottom: 10px;
    }
    .meta .left{
      display:flex;
      flex-direction:column;
      gap: 2px;
      min-width: 0;
    }
    .meta .big{
      font-size: 16px;
      font-weight: 800;
      letter-spacing: -0.4px;
      color: var(--wine);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .meta .small{
      font-size: 12px;
      color: var(--muted);
    }

    .hint{
      color: var(--muted);
      font-size: 12px;
      margin-top: 10px;
      line-height: 1.45;
    }
    .error{
      color:#c0392b;
      font-size: 13px;
      margin-top: 10px;
      white-space: pre-wrap;
      display:none;
    }

    /* ===== 2x2 Square Cards ===== */
    .grid{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-top: 14px;
    }
    .sq{
      aspect-ratio: 1 / 1;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
    }
    .lbl{
      font-size: 13px;
      font-weight: 700;
      color: var(--muted);
      letter-spacing: -0.2px;
    }
    .val{
      font-size: 30px;
      font-weight: 800;
      letter-spacing: -0.8px;
      color: var(--wine);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="title">한빔한복 전지점 랜딩유입 리포트</div>

    <div class="card">
      <!-- 2) Branch dropdown -->
      <select id="branchSelect" aria-label="지점 선택">
        <option value="전체">전체</option>
      </select>

      <!-- 3) Day / Month / Year + Line Chart -->
      <div class="seg" role="tablist" aria-label="기간 필터">
        <button type="button" class="active" data-group="day">일</button>
        <button type="button" data-group="month">월</button>
        <button type="button" data-group="year">년</button>
      </div>

      <div class="card chartCard">
        <div class="meta">
          <div class="left">
            <div class="big" id="metaTitle">전체 · 일</div>
            <div class="small" id="metaRange">-</div>
          </div>
          <div class="big" id="metaTotal">0</div>
        </div>

        <canvas id="lineChart" height="190"></canvas>

        <div class="hint">
          • 네이버예약(reserve)은 <b>오버레이 + CTA</b> 클릭이 합산됩니다.<br>
          • “더 알아보기”는 지점을 선택하지 않은 경우 <b>전체</b>로 집계될 수 있습니다.
        </div>
        <div class="error" id="errBox"></div>
      </div>

      <!-- 4) Square cards (2x2) -->
      <div class="grid">
        <div class="card sq">
          <div class="lbl">네이버예약</div>
          <div class="val" id="cardReserve">0</div>
        </div>
        <div class="card sq">
          <div class="lbl">전화문의</div>
          <div class="val" id="cardCall">0</div>
        </div>
        <div class="card sq">
          <div class="lbl">카톡문의</div>
          <div class="val" id="cardKakao">0</div>
        </div>
        <div class="card sq">
          <div class="lbl">더 알아보기</div>
          <div class="val" id="cardMore">0</div>
        </div>
      </div>
    </div>
  </div>

<script>
  /** ✅ 네 GAS WebApp URL로 바꿔 */
  const GAS_URL = "https://script.google.com/macros/s/AKfycbyiPaERPD1ZUBNO7T40wR5Tcy0jU0qtw5SRwBylCHAvRSjafqHOLGkAWGhxKyUgCerM/exec";

  /** 지점 목록(필요하면 이름을 실제 운영 표기와 100% 동일하게 맞춰) */
  const BRANCHES = [
    "부산점","센텀점","울산점","김해점","양산점","창원점","마산점","진주점","인천점","안산점","대구점","포항점"
  ];

  const $ = (id)=>document.getElementById(id);

  function fmt(n){
    try{ return Number(n||0).toLocaleString("ko-KR"); }catch(e){ return String(n||0); }
  }

  // 기본 표시 기간
  // - day: 최근 14일
  // - month: 최근 12개월
  // - year: 최근 5년
  function dateISO(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const da = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${da}`;
  }
  function rangeFor(group){
    const now = new Date();
    const to = dateISO(now);

    const fromD = new Date(now);
    if(group === "day")   fromD.setDate(fromD.getDate() - 13);
    if(group === "month") fromD.setMonth(fromD.getMonth() - 11);
    if(group === "year")  fromD.setFullYear(fromD.getFullYear() - 4);

    if(group === "month"){ fromD.setDate(1); }
    if(group === "year"){  fromD.setMonth(0); fromD.setDate(1); }

    return { from: dateISO(fromD), to };
  }

  // Chart
  let chart = null;
  function renderChart(labels, values){
    const ctx = $("lineChart").getContext("2d");
    if(chart) chart.destroy();

    chart = new Chart(ctx, {
      type: "line",
      data: {
        labels,
        datasets: [{
          label: "클릭",
          data: values,
          borderColor: "#7A1E2C",
          backgroundColor: "rgba(122,30,44,0.15)",
          tension: 0.35,
          pointRadius: 2,
          pointHoverRadius: 4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display:false },
          tooltip: {
            callbacks: {
              label: (c)=> ` ${fmt(c.raw)}`
            }
          }
        },
        scales: {
          x: {
            ticks: { color: "#8c8c8c", maxRotation: 0, autoSkip: true },
            grid: { color: "rgba(122,30,44,0.10)" }
          },
          y: {
            ticks: { color: "#7A1E2C" },
            grid: { color: "rgba(122,30,44,0.10)" }
          }
        }
      }
    });
  }

  function setActiveGroup(group){
    document.querySelectorAll(".seg button").forEach(b=>{
      b.classList.toggle("active", b.dataset.group === group);
    });
  }

  function showError(msg){
    const box = $("errBox");
    box.style.display = "block";
    box.textContent = msg;
  }
  function hideError(){
    const box = $("errBox");
    box.style.display = "none";
    box.textContent = "";
  }

  async function fetchReport({branch="전체", group="day"}){
    const { from, to } = rangeFor(group);
    const url =
      `${GAS_URL}?page=report` +
      `&branch=${encodeURIComponent(branch)}` +
      `&group=${encodeURIComponent(group)}` +
      `&from=${encodeURIComponent(from)}` +
      `&to=${encodeURIComponent(to)}`;

    const res = await fetch(url, { method:"GET" });
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    return await res.json();
  }

  async function refresh(){
    hideError();

    const branch = $("branchSelect").value || "전체";
    const groupBtn = document.querySelector(".seg button.active");
    const group = groupBtn ? groupBtn.dataset.group : "day";

    const mapGroupLabel = { day:"일", month:"월", year:"년" };

    try{
      const data = await fetchReport({branch, group});

      $("metaTitle").textContent = `${(data.branch || branch)} · ${(mapGroupLabel[data.group] || mapGroupLabel[group] || "일")}`;
      $("metaRange").textContent = (data.range?.from && data.range?.to) ? `${data.range.from} ~ ${data.range.to}` : "-";
      $("metaTotal").textContent = fmt(data.cards?.total || 0);

      $("cardReserve").textContent = fmt(data.cards?.reserve || 0);
      $("cardCall").textContent    = fmt(data.cards?.call || 0);
      $("cardKakao").textContent   = fmt(data.cards?.kakao || 0);
      $("cardMore").textContent    = fmt(data.cards?.more || 0);

      renderChart(data.labels || [], data.values || []);
    }catch(err){
      showError("리포트 로드 실패\n" + (err?.message || String(err)));
      $("metaTotal").textContent = "0";
      $("cardReserve").textContent = "0";
      $("cardCall").textContent = "0";
      $("cardKakao").textContent = "0";
      $("cardMore").textContent = "0";
      renderChart([], []);
    }
  }

  function init(){
    const sel = $("branchSelect");
    BRANCHES.forEach(b=>{
      const opt = document.createElement("option");
      opt.value = b;
      opt.textContent = b;
      sel.appendChild(opt);
    });

    sel.addEventListener("change", refresh);

    document.querySelectorAll(".seg button").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        setActiveGroup(btn.dataset.group);
        refresh();
      });
    });

    refresh();
  }

  init();
</script>
</body>
</html>
